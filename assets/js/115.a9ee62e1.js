(window.webpackJsonp=window.webpackJsonp||[]).push([[115],{795:function(t,s,a){"use strict";a.r(s);var n=a(8),r=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"微前端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#微前端"}},[t._v("#")]),t._v(" 微前端")]),t._v(" "),a("p",[t._v("微前端（Micro-Frontends）是一种类似于微服务的架构，它将微服务的理念应用于浏览器端，即将 Web 应用由单一的单体应用转变为多个小型前端应用聚合为一的应用。")]),t._v(" "),a("p",[t._v("微前端并不是前端领域的新概念。早期希望前端工程能够像后台的微服务一样，项目分开自治，核心的诉求是：")]),t._v(" "),a("ol",[a("li",[t._v("兼容不同技术栈")]),t._v(" "),a("li",[t._v("将项目看作页面、组件，能够复用到不同的系统中")]),t._v(" "),a("li",[t._v("实现页面低成本接入是微前端的重要愿景之一，也是吸引大家持续探索的核心原因。")])]),t._v(" "),a("h3",{attrs:{id:"single-spa"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#single-spa"}},[t._v("#")]),t._v(" single-spa")]),t._v(" "),a("h3",{attrs:{id:"micro-app"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#micro-app"}},[t._v("#")]),t._v(" micro-app")]),t._v(" "),a("h3",{attrs:{id:"无界"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#无界"}},[t._v("#")]),t._v(" 无界")]),t._v(" "),a("h3",{attrs:{id:"pnpm-workspace"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pnpm-workspace"}},[t._v("#")]),t._v(" pnpm workspace")]),t._v(" "),a("h3",{attrs:{id:"qiankun"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#qiankun"}},[t._v("#")]),t._v(" qiankun")]),t._v(" "),a("p",[t._v("qiankun 是一个基于 single-spa 的微前端实现库，旨在帮助大家能更简单、无痛的构建一个生产可用微前端架构系统。目标直指巨石应用业务难题，旨在解决单体应用在一个相对长的时间跨度下，由于参与的人员、团队的增多、变迁，从一个普通应用演变成一个巨石应用 (Frontend Monolith) 后，随之而来的应用不可维护的问题。这类问题在企业级 Web 应用中尤其常见。")]),t._v(" "),a("p",[t._v("微前端的概念借鉴自后端的微服务，主要是为了解决大型工程在变更、维护、扩展等方面的困难而提出的。目前主流的微前端方案包括以下几个：")]),t._v(" "),a("ul",[a("li",[t._v("iframe")]),t._v(" "),a("li",[t._v("基座模式，主要基于路由分发，qiankun 和 single-spa 就是基于这种模式")]),t._v(" "),a("li",[t._v("组合式集成，即单独构建组件，按需加载，类似 npm 包的形式")]),t._v(" "),a("li",[t._v("EMP，主要基于 Webpack5 Module Federation")]),t._v(" "),a("li",[t._v("Web Components")])]),t._v(" "),a("blockquote",[a("p",[t._v("严格来讲，这些方案都不算是完整的微前端解决方案，它们只是用于解决微前端中运行时容器的相关问题。")])]),t._v(" "),a("ol",[a("li",[t._v("who: 包含 qiankun 客户端、主应用 A、微应用 B 三部分，三者协作完成了微前端的设计。")])]),t._v(" "),a("p",[t._v("在 qiankun 的框架下，一个页面集成到另外一个页面系统中，最关键的核心点就是将微应用封装成具有生命周期的页面组件，使得 qiankun 可以调用 React 或者 Vue 的 render 能力，将页面渲染到对应的 DOM 节点。")]),t._v(" "),a("p",[t._v("有个小细节就是微应用的 JS CSS 文件请求是属于 Ftech/XHR 类型，说明 js 文件的请求是 qiankun 客户端自行构造的。")]),t._v(" "),a("p",[t._v("这里必然要涉及前端的跨域问题，尤其是当主应用和微应用的域名不一致时，qiankun 客户端如何能够在跨域的限制之下获取到微应用的页面资源？一个解决方案是主应用提供一个鉴权秘钥下发的接口 signUrl，这个接口由微应用提供也可以，将秘钥信息下发到 cookie 中，通过配置 qiankun 自定义 fetch 方法，带上这些鉴权信息。官方也提供了一些通用方案以供参考。")]),t._v(" "),a("h3",{attrs:{id:"微应用改造"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#微应用改造"}},[t._v("#")]),t._v(" 微应用改造")]),t._v(" "),a("p",[t._v("一个业务系统并不是一开始就有被集成的价值的，往往是在业务发展到一定程度，经过市场验证其价值之后，大家才会明确这个业务系统具有微应用改造的价值，这就导致一个窘迫的境地：你需要改造已经成型的项目，使其成为可快速接入的微应用。")]),t._v(" "),a("p",[t._v("qiankun 的微应用改造相对比较简单，一般在开启严格沙箱模式之后，微应用和主应用之间建立比较好的环境隔离，你并不需要太多的工作。")]),t._v(" "),a("ol",[a("li",[t._v("首先样式隔离，参考下面 css 隔离。其核心的麻烦在于 qiankun 启动严格沙箱模式之后，会导致 dialog、Modal 等组件无法找到 body 节点，进而无法挂载到 DOM 中。")]),t._v(" "),a("li",[t._v("其次 JS 作用域隔离，这里主要是一些第三方库会在 window 上挂在单例实例，导致主应用和微应用之间单例配置相互覆盖，常见于日志上报、微信 SDK、QQ SDK 等第三方应用。解决方案分为两个方向:\n"),a("ul",[a("li",[t._v("假如主应用存在则沿用主应用的配置：这种方式对主应用比较有利。以日志上报的配置为例，微应用的日志会上报到主应用空间下，那么主应用的日志监控会很完整。缺点则是微应用本身失去了这些监控信息。")]),t._v(" "),a("li",[t._v("微应用对自身使用的单例进行隔离：这种方式对微应用比较有利。以 Axios 的配置为例，子应用可以实现类似中台应用的效果，可以探知到微应用在不同的主应用中的实际使用场景和数据统计。")]),t._v(" "),a("li",[t._v("采用第二种方式时，假如主应用需要进行数据共享或者配置共享，可以通过主应用和微应用之间的参数和数据传递的方式来实现共享，微应用提供丰富的监听 hooks。")])])])]),t._v(" "),a("h3",{attrs:{id:"faq"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#faq"}},[t._v("#")]),t._v(" FAQ")]),t._v(" "),a("h4",{attrs:{id:"_1-如何解决第三方-sdk、js-文件加载失败问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-如何解决第三方-sdk、js-文件加载失败问题"}},[t._v("#")]),t._v(" 1. 如何解决第三方 SDK、JS 文件加载失败问题")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("原因：微信和企业微信的 SDK 是不可以自行构建 Http 请求加载的，这是由于其安全策略导致的，且每次返回的内容有安全限制的改动，无法复用。")])]),t._v(" "),a("li",[a("p",[t._v("结果：因此必须要在 html 的 header 中引入，但 qiankun 会对 html - header 所有 script、link 资源构造请求链接，进而导致获取第三方 SDK 的请求报错，整个 qiankun 客户端加载微应用进程报错，无法加载出对应页面。")])]),t._v(" "),a("li",[a("p",[t._v("官网在常见问题给了三个解决方案：")]),t._v(" "),a("ol",[a("li",[t._v("使用 getTemplate 过滤异常脚本；")]),t._v(" "),a("li",[t._v("使用自定义 fetch 阻断 script 脚本；")]),t._v(" "),a("li",[t._v("终极方案 - 修改 html 的 content-type；")])])])]),t._v(" "),a("p",[t._v("前两种方案需要在乾坤渲染函数中增加一个对应的参数，这里面有个坑点，则是 prefetchApps 不支持这些参数，因此一旦启用预加载函数，则会导致渲染函数的传入配置失效，因此需要关闭使用预加载函数。")]),t._v(" "),a("h4",{attrs:{id:"_2-css-隔离"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-css-隔离"}},[t._v("#")]),t._v(" 2. css 隔离")]),t._v(" "),a("ul",[a("li",[t._v("微前端核心理念：解耦 / 技术栈无关，简单来说就是希望微应用之间，基站应用和微应用之间的技术栈可以互相隔离，从而各种定制自己的技术体系来实现开发效率和产品质量的最优化配置，这也是微前端的核心价值体现。")]),t._v(" "),a("li",[t._v("主流的沙箱模式是通过创建一个独立的作用域隔离作用域链，同时克隆全局变量来实现的，但是这种隔离 + 克隆方案并不完美，在复杂运行场景中，无论性能还是安全性都是难以保证的，特别是 CSS 的隔离。")])]),t._v(" "),a("ol",[a("li",[t._v("首先是基础页面的 CSS，采用的是成熟的 CSS module 方案，简单来说就是将 CSS 变成局部生效，每个 class 生成一个独一无二的名字。从最早的 Less、SASS，到后来的 PostCSS，再到最近的 CSS in JS，都是为了解决 CSS 全局生效带来的副作用。")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s/3SogWNKKJvbaQbvPMg7lVg",target:"_blank",rel:"nofollow noopener noreferrer"}},[t._v("参考这里"),a("OutboundLink")],1)])]),t._v(" "),a("h3",{attrs:{id:"微前端集成优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#微前端集成优化"}},[t._v("#")]),t._v(" 微前端集成优化")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("减少子应用体积：让所有子应用体积更小，加载更快，在代码层的优化，比如按需加载、懒加载、静态资源优化、cdn 等的都是大家熟知的方案")]),t._v(" "),a("ul",[a("li",[t._v("打包优化：gzip 压缩和依赖共享")]),t._v(" "),a("li",[t._v("代码分割：按需加载和动态加载")]),t._v(" "),a("li",[t._v("静态资源优化：图片压缩、字体压缩、css 压缩、js 压缩（tree-shaking 等）等")]),t._v(" "),a("li",[t._v("cdn 加速：通过 cdn 加速静态资源，减少请求次数，提高性能")]),t._v(" "),a("li",[t._v("缓存策略：缓存静态资源，减少请求次数，提高性能")]),t._v(" "),a("li",[t._v("错误处理：错误处理，如 404、500 等，优化用户体验")]),t._v(" "),a("li",[t._v("监控：监控系统，如监控用户访问量、页面性能、错误日志等，优化用户体验")]),t._v(" "),a("li",[t._v("优化：如减少请求次数、减少请求体积、减少渲染时间、减少内存占用等，优化用户体验")])])]),t._v(" "),a("li",[a("p",[t._v("影响一个前端服务体积、加载速度的主要文件就是第三方依赖"),a("code",[t._v("chunk-vendors.js")])])])]),t._v(" "),a("h4",{attrs:{id:"依赖共享"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#依赖共享"}},[t._v("#")]),t._v(" 依赖共享")]),t._v(" "),a("p",[t._v("未优化时：假设我们有非常多的子应用，每个子应用的 node_modlues 依赖打包也是单独的，在请求这个子应用时，这个依赖文件也是必须请求的。但是很多子应用的第三方依赖都是重复的。比如 vue 的底层依赖、store 的依赖、eslint 的依赖及一些常用的工具依赖。")]),t._v(" "),a("ol",[a("li",[t._v("外部化依赖：最简单的实现方案就是可以将常用的依赖库配置为外部依赖，不打包在每个子应用中，而是通过 CDN 加载。当我们加载主应用时，主应用通过 CDN 的方式请求了 vue 的底层依赖、一些常用的公共库等所有依赖。当我们加载子应用时，和主应用相同的这些依赖因为已经请求过了，浏览器会通过缓存机制直接读取已经缓存的数据，避免了重新请求，子应用的加载速度也得到了进一步的提升！\n"),a("ul",[a("li",[t._v("使用"),a("code",[t._v("vite-plugin-cdn-import")])])])])]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// vite.config.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" defineConfig "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"vite"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" cdnImport "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"vite-plugin-cdn-import"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("defineConfig")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("plugins")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cdnImport")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("imports")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 库名，比如 `react`")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("libraryName")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"react"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 库的CDN地址，比如 `https://cdn.jsdelivr.net/npm/react@17.0.1/umd/react.production.min.js`")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("url")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://cdn.jsdelivr.net/npm/react@17.0.1/umd/react.production.min.js"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 生产环境是否使用CDN")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("prod")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 开发环境是否使用CDN")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("dev")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 可以继续添加其他库的配置...")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br")])])])}),[],!1,null,null,null);s.default=r.exports}}]);